name: CI
on:
  push:
    branches: [ "development" ]
  pull_request:
    branches: [ "**" ]

jobs:
  Parse_nix:
    name: Parse .nix files
    runs-on: [ubuntu-24.04]
    steps:
      - name: Checkout repository
        uses: "actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683"

      - name: Install Lix
        uses: samueldr/lix-gha-installer-action@v1

      - name: "Parse .nix files"
        run: .ci/parse-all.sh
  # Temporarily disable instantiation due to OOM.
  # WIP work is under way to make this work again.
  #Instantiation:
  #  name: Instantiation
  #  runs-on: [ubuntu-24.04]
  #  steps:
  #    - name: Checkout repository
  #      uses: "actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683"

  #    - name: Install Lix
  #      uses: samueldr/lix-gha-installer-action@v1

  #    - name: "Instantiation"
  #      run: |
  #        export NIX_PATH=nixpkgs=$PWD/pkgs.nix
  #        bin/hydra-eval
  Kernel_configuration_up-to-date:
    name: Kernel configuration up-to-date
    runs-on: [ubuntu-24.04]
    steps:
      - name: Checkout repository
        uses: "actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683"

      - name: Install Lix
        uses: samueldr/lix-gha-installer-action@v1

      - name: "Kernel configuration up-to-date"
        run: |
          export NIX_PATH=nixpkgs=$PWD/pkgs.nix
          bin/kernel-normalize-all --only-check

  depend-on-kernels-builds:
    name: Kernel builds
    uses: ./.github/workflows/release-builds.yml
    with:
      bucket: kernels

  depend-on-overlay-builds:
    name: Overlay builds
    uses: ./.github/workflows/release-builds.yml
    with:
      bucket: overlay

  depend-on-image-builds:
    name: Image Builds
    uses: ./.github/workflows/release-builds.yml
    with:
      bucket: images
    needs:
      - depend-on-kernels-builds
      - depend-on-overlay-builds
